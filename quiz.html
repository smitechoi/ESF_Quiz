<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>객관식 퀴즈</title>
</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

    </script>
    <h1 id="question">로딩 중...</h1>
    <div id="options"></div>
    <button onclick="submitAnswer()">제출</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8SJjT_qbpw90ahkq-v36wO5sJTDh0qeM",
            authDomain: "esf-quiz.firebaseapp.com",
            projectId: "esf-quiz",
            storageBucket: "esf-quiz.firebasestorage.app",
            messagingSenderId: "974289794287",
            appId: "1:974289794287:web:c5c2e1c276d7536521971a"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let quizData = [];
        let currentQuestion = {};
        let score = 0;
        let totalQuestions = 5;
        let answeredQuestions = [];

        // CSV에서 데이터 로드
        fetch("https://raw.githubusercontent.com/smitechoi/esf_quiz/main/quiz.csv")
            .then(response => response.text())
            .then(data => {
                quizData = Papa.parse(data, { header: true }).data;
                loadQuestion();
            });

        function loadQuestion() {
            if (answeredQuestions.length >= totalQuestions) {
                finishQuiz();
                return;
            }
            let index = Math.floor(Math.random() * quizData.length);
            currentQuestion = quizData[index];

            document.getElementById("question").innerText = currentQuestion.Question;
            let options = currentQuestion.Options.split(",");
            let optionsHtml = options.map(option => `
                <label>
                    <input type="radio" name="answer" value="${option}"> ${option}
                </label><br>
            `).join("");

            document.getElementById("options").innerHTML = optionsHtml;
        }

        function submitAnswer() {
            let selectedOption = document.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                alert("답변을 선택해주세요!");
                return;
            }
            let userAnswer = selectedOption.value;
            let isCorrect = userAnswer === currentQuestion.Answer;

            answeredQuestions.push({
                question: currentQuestion.Question,
                userAnswer: userAnswer,
                correctAnswer: currentQuestion.Answer,
                isCorrect: isCorrect
            });

            if (isCorrect) score++;
            loadQuestion();
        }

        function finishQuiz() {
            let result = {
                timestamp: new Date().toISOString(),
                score: score,
                total: totalQuestions,
                details: answeredQuestions
            };

            // Firestore에 결과 저장
            db.collection("quizResults").add(result)
                .then((docRef) => {
                    console.log("결과 저장 완료: ", docRef.id);
                    window.location.href = `result.html?id=${docRef.id}`; // 결과 페이지 이동
                })
                .catch((error) => {
                    console.error("오류 발생: ", error);
                });
        }
    </script>

</body>

</html>